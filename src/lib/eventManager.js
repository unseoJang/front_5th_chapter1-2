/**
 * @file eventManager.js
 * @description
 * DOM ìš”ì†Œì— ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ë“±ë¡í•˜ì§€ ì•Šê³ ,
 * ì´ë²¤íŠ¸ ìœ„ì„(delegation)ì„ í™œìš©í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆì…ë‹ˆë‹¤.
 *
 * âœ… ì£¼ìš” íŠ¹ì§•
 * - ë£¨íŠ¸ ìš”ì†Œ(root)ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•˜ê³ , ìì‹ ìš”ì†Œì— ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * - ê°œë³„ ìš”ì†Œë§ˆë‹¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¶™ì´ì§€ ì•Šì•„ë„ ë˜ë¯€ë¡œ ì„±ëŠ¥ ë° ë©”ëª¨ë¦¬ ì¸¡ë©´ì—ì„œ íš¨ìœ¨ì ì…ë‹ˆë‹¤.
 * - í•¸ë“¤ëŸ¬ëŠ” ë‚´ë¶€ ì €ì¥ì†Œ(eventStore)ì— ê¸°ë¡ë˜ë©°, ì‹¤ì œ ì‹¤í–‰ì€ ë£¨íŠ¸ì˜ ë¦¬ìŠ¤ë„ˆì—ì„œ ì¼ì–´ë‚©ë‹ˆë‹¤.
 *
 * âœ… í¬í•¨ëœ ê¸°ëŠ¥
 * - `addEvent(element, eventType, handler)`
 *   : ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë‚´ë¶€ ì €ì¥ì†Œì— ë“±ë¡í•©ë‹ˆë‹¤. DOMì—ëŠ” ì§ì ‘ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
 *
 * - `setupEventListeners(root)`
 *   : ë£¨íŠ¸ ìš”ì†Œì— ì‹¤ì œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í•œ ë²ˆë§Œ ë“±ë¡í•©ë‹ˆë‹¤. ì´í›„ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 *
 * - `removeEvent(element, eventType, handler)`
 *   : ì €ì¥ëœ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì œê±°í•©ë‹ˆë‹¤. í•¸ë“¤ëŸ¬ê°€ ëª¨ë‘ ì œê±°ë˜ë©´ í•´ë‹¹ ìš”ì†Œì˜ ì´ë²¤íŠ¸ë„ ì œê±°ë©ë‹ˆë‹¤.
 *
 * âœ… ì‚¬ìš© ì˜ˆì‹œ
 * ```js
 * const container = document.getElementById("root");
 * const button = document.createElement("button");
 *
 * addEvent(button, "click", () => console.log("clicked!"));
 * container.appendChild(button);
 *
 * setupEventListeners(container); // ë°˜ë“œì‹œ í•œ ë²ˆë§Œ í˜¸ì¶œ
 * ```
 *
 * âœ… ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ 
 * - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ìˆ˜ë°± ê°œ ë¶™ì´ëŠ” ë¹„ìš©ì„ ì¤„ì´ê¸° ìœ„í•´
 * - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ ë° ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´
 * - ì»´í¬ë„ŒíŠ¸ê°€ ìì£¼ ìƒì„±/ì œê±°ë˜ëŠ” í™˜ê²½(ì˜ˆ: SPA)ì—ì„œ ì •ë¦¬í•˜ê¸° ì‰¬ì›€
 */

// "ìš”ì†Œì— íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì–´ë–¤ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œë¼"
// ë¼ëŠ” ìš”ì²­ì„ ë°›ì•„ì„œ,
// ğŸ“¦ ë‚´ë¶€ ì €ì¥ì†Œì— ê·¸ ì •ë³´ë¥¼ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜ì•¼.
const eventStore = new Map(); // ë‚´ë¶€ ì´ë²¤íŠ¸ ì €ì¥ì†Œ ë§Œë“¤ê¸° êµ¬ì¡°: element â†’ { click: [handler1, handler2], input: [...] }
const supportedEvents = ["click", "mouseover", "focus", "keydown", "submit"]; // í˜„ì¬ ì±•í„°ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì´ë²¤íŠ¸ë“¤, ë§Œì•½ ì—¬ê¸°ì„œ ì´ë²¤íŠ¸ ë§ê³  ë‹¤ë¥¸ ì´ë²¤íŠ¸ë“¤ì„ ì‚¬ìš©í•œë‹¤ë©´ í•´ë‹¹ ë°°ì—´ì— ì¶”ê°€í•´ì•¼í•¨

/**
 * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
 * âœ… root ìš”ì†Œ í•˜ë‚˜ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¶™ì´ê³ ,
 *â— ìì‹ ìš”ì†Œë“¤ì´ í´ë¦­ë˜ì—ˆì„ ë•Œ ëˆ„êµ¬ë¥¼ ëˆŒë €ëŠ”ì§€ ì¶”ì í•´ì„œ
 * ğŸ‘‰ addEvent()ë¡œ ë“±ë¡í•œ í•¸ë“¤ëŸ¬ë¥¼ ì‹¤í–‰í•¨!
 * @param {*} root // ë£¨íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸
 * @description ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ ë£¨íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
 * ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ê°€ì¥ ê°€ê¹Œìš´ ìƒìœ„ ìš”ì†Œì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ ì°¾ì•„ ì‹¤í–‰í•©ë‹ˆë‹¤.
 **/
export function setupEventListeners(root) {
  //1. ë£¨íŠ¸ì— í´ë¦­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  supportedEvents.forEach((type) => {
    root.addEventListener(type, (e) => {
      // 2. ì´ë²¤íŠ¸ ë°œìƒí•œ íƒ€ê²Ÿ ê°€ì ¸ì˜¤ê¸°
      let target = e.target;
      //  3. ì´ë²¤íŠ¸ ì „íŒŒ ë”°ë¼ ìœ„ë¡œ ì˜¬ë¼ê°€ë©° íƒìƒ‰
      while (target && target !== root) {
        //4 . í•´ë‹¹ ìš”ì†Œì— ë“±ë¡ëœ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¾ê¸°
        const events = eventStore.get(target);
        const handlers = events?.[type];

        // 5. í•¸ë“¤ëŸ¬ ì‹¤í–‰
        if (handlers?.length) {
          handlers.slice().forEach((fn) => fn(e));
          break; // ê°€ì¥ ê°€ê¹Œìš´ í•œ ìš”ì†Œë§Œ ì‹¤í–‰ (React ìŠ¤íƒ€ì¼) ë”± í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ê²Œ í•¨
        }

        // 6. ë‹¤ìŒ ë¶€ëª¨ë¡œ íƒ€ê²Ÿ ì´ë™
        target = target.parentNode;
      }
    });
  });
}

/**
 * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
 * @param {*} element // ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•  ì—˜ë¦¬ë¨¼íŠ¸
 * @param {*} eventType // ì¶”ê°€í•  ì´ë²¤íŠ¸ íƒ€ì… (ì˜ˆ: 'click', 'input')
 * @param {*} handler // ì¶”ê°€í•  í•¸ë“¤ëŸ¬ í•¨ìˆ˜
 * @returns
 * @description ì´ í•¨ìˆ˜ëŠ” ì´ë²¤íŠ¸ ìœ„ì„ ì‹œìŠ¤í…œì˜ ê¸°ë°˜ì„ ë§Œë“œëŠ” í•¨ìˆ˜
 * ìš”ì†Œ(element)ì— íŠ¹ì • ì´ë²¤íŠ¸(eventType)ê°€ ë°œìƒí•˜ë©´ ì´ í•¨ìˆ˜(handler)ë¥¼ ë‚˜ì¤‘ì— ì‹¤í–‰
 * ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ elementì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ í•¸ë“¤ëŸ¬ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
 * ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ í•´ë‹¹ í•¸ë“¤ëŸ¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
 * ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ ë£¨íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
 */
export function addEvent(element, eventType, handler) {
  // console.log(element, eventType, handler);
  // 1. í•´ë‹¹ elementì— ëŒ€í•œ ì´ë²¤íŠ¸ ì €ì¥ ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê¸°
  if (!eventStore.has(element)) {
    eventStore.set(element, {});
  }

  // 2. í•´ë‹¹ elementì˜ ì´ë²¤íŠ¸ ëª©ë¡ êº¼ë‚´ì˜¤ê¸°
  const events = eventStore.get(element);

  // 3. íŠ¹ì • ì´ë²¤íŠ¸ íƒ€ì…(click ë“±)ì˜ í•¸ë“¤ëŸ¬ ë°°ì—´ì´ ì—†ìœ¼ë©´ ë§Œë“¤ê¸°
  if (!events[eventType]) {
    events[eventType] = [];
  }

  // 4. í•¸ë“¤ëŸ¬ ì¶”ê°€
  events[eventType].push(handler);
}

/**
 * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° - removeEvent() í•¨ìˆ˜ëŠ” addEvent()ë¡œ ë“±ë¡í•´ë‘” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
 * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° ì´ìœ 
 * 1. â— ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ (Memory Leak)
 * DOM ìš”ì†Œê°€ ì‚¬ë¼ì¡ŒëŠ”ë°ë„ ë¦¬ìŠ¤ë„ˆê°€ ë‚¨ì•„ìˆìœ¼ë©´?
 * JavaScriptëŠ” ê·¸ ë¦¬ìŠ¤ë„ˆ ë•Œë¬¸ì— ê·¸ ìš”ì†Œë¥¼ ê³„ì† ë©”ëª¨ë¦¬ì— ë¶™ì¡ê³  ìˆìŒ
 * â†’ ë¸Œë¼ìš°ì € ì„±ëŠ¥ ì €í•˜, ëŠë ¤ì§, ëˆ„ì ë˜ë©´ ì•±ì´ í„°ì§ ğŸ’¥
 * 2. ğŸ˜µ ë¶ˆí•„ìš”í•œ í•¨ìˆ˜ ì‹¤í–‰ ë°©ì§€
 * click í•  ë•Œë§ˆë‹¤ ì˜ˆì „ í•¸ë“¤ëŸ¬ê¹Œì§€ ì¤‘ë³µìœ¼ë¡œ ì‹¤í–‰ë  ìˆ˜ ìˆìŒ
 * 3. ğŸ§¼ ì •ë¦¬ ì•ˆ í•˜ë©´ ë””ë²„ê¹… ì§€ì˜¥
 * 4. âœ… ë¦¬ì•¡íŠ¸, ë·°, ìŠ¤ë²¨íŠ¸ ë“± í”„ë ˆì„ì›Œí¬ë„ ë‚´ë¶€ì—ì„œ í•­ìƒ ì œê±°í•¨!
 * @param {*} element // ì´ë²¤íŠ¸ë¥¼ ì œê±°í•  ì—˜ë¦¬ë¨¼íŠ¸
 * @param {*} eventType // ì œê±°í•  ì´ë²¤íŠ¸ íƒ€ì… (ì˜ˆ: 'click', 'input')
 * @param {*} handler // ì œê±°í•  í•¸ë“¤ëŸ¬ í•¨ìˆ˜
 * @returns
 */
export function removeEvent(element, eventType, handler) {
  // 1. í•´ë‹¹ ìš”ì†Œì˜ ì´ë²¤íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° -> âœ… ì¦‰, "ì—†ìœ¼ë©´ ì•ˆ ê±´ë“œë¦¼"
  const events = eventStore.get(element);
  if (!events || !events[eventType]) return;

  // 2. í•´ë‹¹ í•¸ë“¤ëŸ¬ë§Œ í•„í„°ë§
  events[eventType] = events[eventType].filter(
    (/** @type {any} */ fn) => fn !== handler,
  );

  // ë” ì´ìƒ ë“±ë¡ëœ í•¸ë“¤ëŸ¬ê°€ ì—†ë‹¤ë©´ ì •ë¦¬
  if (events[eventType].length === 0) {
    delete events[eventType];
  }

  // í•´ë‹¹ elementì— ì–´ë–¤ ì´ë²¤íŠ¸ë„ ì—†ë‹¤ë©´ ì „ì²´ ì œê±°
  if (Object.keys(events).length === 0) {
    eventStore.delete(element);
  }
}
